<!doctype html><html lang=zh data-theme><head><title>Amao Three | 在ArchLinux下编译LineageOS16.0</title><meta charset=utf-8><meta name=generator content="Hugo 0.81.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=description content="天下有大勇者，卒然临之而不惊，无故加之而不怒；此其所挟持者甚大，而其志甚远也。--苏轼"><link rel=stylesheet href=https://amaothree.github.io/css/style.min.0c643de4008adca329f7a2d616ce308cca99d4ef45e4cca307323e7857910194.css integrity="sha256-DGQ95ACK3KMp96LWFs4wjMqZ1O9F5MyjBzI+eFeRAZQ=" crossorigin=anonymous type=text/css><link rel=stylesheet href=https://amaothree.github.io/css/markupHighlight.min.f798cbda9aaa38f89eb38be6414bd082cfd71a6780375cbf67b6d2fb2b96491e.css integrity="sha256-95jL2pqqOPies4vmQUvQgs/XGmeAN1y/Z7bS+yuWSR4=" crossorigin=anonymous type=text/css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin=anonymous><link rel="shortcut icon" href=https://amaothree.github.io/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=https://amaothree.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://amaothree.github.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://amaothree.github.io/favicon-16x16.png><link rel=canonical href=https://amaothree.github.io/posts/%E5%9C%A8archlinux%E4%B8%8B%E7%BC%96%E8%AF%91lineageos16-0/><script type=text/javascript src=https://amaothree.github.io/js/anatole-header.min.0c05c0a90d28c968a1cad4fb31abd0b8e1264e788ccefed022ae1d3b6f627514.js integrity="sha256-DAXAqQ0oyWihytT7MavQuOEmTniMzv7QIq4dO29idRQ=" crossorigin=anonymous></script><script type=text/javascript src=https://amaothree.github.io/js/anatole-theme-switcher.min.8ef71e0fd43f21a303733dbbecae5438b791d2b826c68a9883bd7aa459a076d2.js integrity="sha256-jvceD9Q/IaMDcz277K5UOLeR0rgmxoqYg716pFmgdtI=" crossorigin=anonymous></script><meta name=twitter:card content="summary"><meta name=twitter:title content="在ArchLinux下编译LineageOS16.0"><meta name=twitter:description content="9/17更新
你依然可以通过本文进行其他类似机型的编译
本人实测小米6刷入编译出来的包会卡米，也就是卡在开机MI logo上，和一些dalao讨论貌似是小米部分机型与lineage自带的clang版本冲突。可能被波及了。等我XDA问完，这边再给可能的解决方案。
就在我痛苦不堪的时候，发现LOS团队悄悄把小米部分机型恢复了。
怕折腾的，还是刷官方包吧。

0x00 背景事件
8月9日，北京商汤在github上提交了DMCA投诉，因为自家授权给小米的面部解锁专利被“开源”，故请求github删除“涉案”的454个repo，这其中主要提及到了TheMuppets团队一直维护的小米vendor仓库。这个仓库也是LineageOS团队（以下简称为LOS）一直依赖（合作）的vendor源。因为这个事件，LOS团队停止了8月8号之后的xiaomi机型的所有offical的ROM编译工作。截止本post编写时，工作依然没有恢复。官网版本一直停留在0808-nightly上。
作者正是LOS16的用户，这个类原生OS一直给我带来很好的用户体验。但是不幸的是0808版本遗留下了微信QQ等网络电话APP无法获取录音权限的问题，虽然社区很快接收到了反馈并做了patch。但是因为DMCA事件导致我们现在无法收到OTA更新了。现在和父母以及同学交流非常不便，只能回到宿舍使用ipad打电话。1个月后感觉DMCA事件没有什么解决进展，被逼无奈的我只好自己动手编译最新代码。"><meta property="og:title" content="在ArchLinux下编译LineageOS16.0"><meta property="og:description" content="9/17更新
你依然可以通过本文进行其他类似机型的编译
本人实测小米6刷入编译出来的包会卡米，也就是卡在开机MI logo上，和一些dalao讨论貌似是小米部分机型与lineage自带的clang版本冲突。可能被波及了。等我XDA问完，这边再给可能的解决方案。
就在我痛苦不堪的时候，发现LOS团队悄悄把小米部分机型恢复了。
怕折腾的，还是刷官方包吧。

0x00 背景事件
8月9日，北京商汤在github上提交了DMCA投诉，因为自家授权给小米的面部解锁专利被“开源”，故请求github删除“涉案”的454个repo，这其中主要提及到了TheMuppets团队一直维护的小米vendor仓库。这个仓库也是LineageOS团队（以下简称为LOS）一直依赖（合作）的vendor源。因为这个事件，LOS团队停止了8月8号之后的xiaomi机型的所有offical的ROM编译工作。截止本post编写时，工作依然没有恢复。官网版本一直停留在0808-nightly上。
作者正是LOS16的用户，这个类原生OS一直给我带来很好的用户体验。但是不幸的是0808版本遗留下了微信QQ等网络电话APP无法获取录音权限的问题，虽然社区很快接收到了反馈并做了patch。但是因为DMCA事件导致我们现在无法收到OTA更新了。现在和父母以及同学交流非常不便，只能回到宿舍使用ipad打电话。1个月后感觉DMCA事件没有什么解决进展，被逼无奈的我只好自己动手编译最新代码。"><meta property="og:type" content="article"><meta property="og:url" content="https://amaothree.github.io/posts/%E5%9C%A8archlinux%E4%B8%8B%E7%BC%96%E8%AF%91lineageos16-0/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-09-15T13:53:02+00:00"><meta property="article:modified_time" content="2019-09-15T13:53:02+00:00"><meta property="og:site_name" content="阿毛的随便写写"></head><body><div class="sidebar animated fadeInDown"><div class=logo-title><div class=title><img src=https://amaothree.github.io/images/profile.jpg alt="profile picture"><h3 title><a href=/>阿毛的随便写写</a></h3><div class=description><p>天下有大勇者，卒然临之而不惊，无故加之而不怒；此其所挟持者甚大，而其志甚远也。--苏轼</p></div></div></div><ul class=social-links><li><a href=https://www.linkedin.com/in/yuehao-sui/ rel=me aria-label=Linkedin><i class="fab fa-linkedin fa-2x" aria-hidden=true></i></a></li><li><a href=https://github.com/amaothree rel=me aria-label=GitHub><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li><li><a href=https://www.instagram.com/yoohoo.samuel/ rel=me aria-label=instagram><i class="fab fa-instagram fa-2x" aria-hidden=true></i></a></li><li><a href=mailto:ihidemyname@outlook.com rel=me aria-label=e-mail><i class="fas fa-envelope fa-2x" aria-hidden=true></i></a></li></ul><div class=footer><div class=by_farbox>&copy; Amao Three 2019-2021</div></div></div><div class=main><div class="page-top animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a><ul class=nav id=navMenu><li><a href=/zh/ title>主页</a></li><li><a href=/zh/posts/ title>文章</a></li><li><a href=/zh/about/ title>关于我</a></li><li><a href=https://amaothree.github.io/ title=中文>中文</a></li><li><a href=https://amaothree.github.io/en/ title=EN>EN</a></li><li class=theme-switch-item><a class=theme-switch title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></li></ul></div><div class=autopagerize_page_element><div class=content><div class="post animated fadeInDown"><div class=post-content><div class=post-title><h3>在ArchLinux下编译LineageOS16.0</h3></div><h2 id=917更新>9/17更新</h2><p>你依然可以通过本文进行其他类似机型的编译</p><p><del>本人实测小米6刷入编译出来的包会卡米，也就是卡在开机MI logo上，和一些dalao讨论貌似是小米部分机型与lineage自带的clang版本冲突。可能被波及了。等我XDA问完，这边再给可能的解决方案。</del></p><p>就在我痛苦不堪的时候，发现LOS团队<a href=https://github.com/LineageOS/hudson/commit/9e0206569670a2566562e000b9f1e3492eacca83>悄悄把小米部分机型恢复了。</a></p><p>怕折腾的，还是刷官方包吧。</p><hr><h2 id=0x00-背景事件>0x00 背景事件</h2><p>8月9日，北京商汤在github上提交了<a href=https://github.com/github/dmca/blob/master/2019/08/2019-08-09-SenseTime-5.md>DMCA投诉</a>，因为自家授权给小米的面部解锁专利被“开源”，故请求github删除“涉案”的454个repo，这其中主要提及到了TheMuppets团队一直维护的<a href=https://github.com/TheMuppets/proprietary_vendor_xiaomi>小米vendor仓库</a>。这个仓库也是LineageOS团队（以下简称为LOS）一直依赖（合作）的vendor源。因为这个事件，LOS团队停止了8月8号之后的xiaomi机型的所有offical的ROM编译工作。截止本post编写时，工作依然没有恢复。官网版本一直停留在0808-nightly上。</p><p>作者正是LOS16的用户，这个类原生OS一直给我带来很好的用户体验。但是不幸的是0808版本遗留下了微信QQ等网络电话APP无法获取录音权限的问题，虽然社区很快接收到了反馈并做了patch。但是因为DMCA事件导致我们现在无法收到OTA更新了。现在和父母以及同学交流非常不便，只能回到宿舍使用ipad打电话。1个月后感觉DMCA事件没有什么解决进展，被逼无奈的我只好自己动手编译最新代码。</p><h2 id=0x01-本文参考>0x01 本文参考</h2><table><thead><tr><th style=text-align:center>名称</th><th style=text-align:center>网址</th></tr></thead><tbody><tr><td style=text-align:center>安卓环境搭建与编译 for Arch Linux</td><td style=text-align:center><a href=https://blog.firerain.me/article/13>https://blog.firerain.me/article/13</a></td></tr><tr><td style=text-align:center>Build for sagit</td><td style=text-align:center><a href=https://wiki.lineageos.org/devices/sagit/build>https://wiki.lineageos.org/devices/sagit/build</a></td></tr><tr><td style=text-align:center>Archwiki-Setting up the build environment</td><td style=text-align:center><a href=https://wiki.archlinux.org/index.php/Android#Setting_up_the_build_environment>https://wiki.archlinux.org/index.php/Android#Setting_up_the_build_environment</a></td></tr><tr><td style=text-align:center>Magisk Hide on ADB</td><td style=text-align:center><a href=https://github.com/topjohnwu/Magisk/issues/688>https://github.com/topjohnwu/Magisk/issues/688</a></td></tr></tbody></table><h2 id=0x02-本文编译环境>0x02 本文编译环境</h2><p>OS：Arch Linux<br>AUR Helper：yay （其他helper用户请自觉更改下文相关代码）<br>机型：sagit （Mi6 小米6）（其他机型用户请在下文相关代码自觉替换成自己使用的设备名，不知道的请去LOS官网上查看）</p><h2 id=0x03-编译前准备工作>0x03 编译前准备工作</h2><p><strong>在开始前，还是建议有丰富linux操作经验的人进行编译，如果你是新手，并希望从中学到东西，请结合的看0x01部分的文章，因为本文不会对每一步进行太多缘由上的解释，因为大多数经验者一看便知。</strong></p><p><strong>每一步都至关重要，但是加粗步骤尤其需要谨慎对待。</strong></p><p><strong>本文及本文作者不对您的数据丢失，系统崩溃，手机变砖等事故负责</strong></p><ol><li>请先确保编译机最低有170GB以上剩余空间，如果你要开cache，你需要更多。有条件者请在服务器与虚拟机上跑。（我穷只能物理机）</li><li>建议8G内存起，并且最好开启swap，这个不是刚需，但是more memory，less wasted time。</li><li><strong>推荐全程使用bash而非zsh或者fish。</strong> 如果你还是想用zsh，请设置一下环境变量。<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash> setopt shwordsplit
 export LC_ALL<span style=color:#f92672>=</span>C
</code></pre></div></li><li>请先yay更新所有包至最新版本。</li><li>安装LOS编译环境，安装AUR包lineageos-devel<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash> yay -S lineageos-devel
</code></pre></div></li><li>创建一个编译环境目录<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash> mkdir ~/lineageos
 cd lineageos
</code></pre></div></li><li>准备python2环境，由于安卓编译只支持python2，但是arch默认为python3，建议通过venv来创建python2环境并避免对系统做大的改动。<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash> yay -S python2-virtualenv
 virtualenv2 --system-site-packages venv
 source venv/bin/activate
</code></pre></div></li></ol><h2 id=0x04-同步los源码>0x04 同步LOS源码</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>    repo init -u git://github.com/LineageOS/android.git -b lineage-16.0 --depth<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
    repo sync -c -j4 --force-sync --no-clone-bundle --no-tags
</code></pre></div><blockquote><p>注: 以上的 &ndash;depth=1 参数代表只保留本地仓库中的最后一个commit, 可减少空间占用, 你也可以不加，如果空间有限，建议下文中的每一步git clone都加上<br>最后一句的 -j4 参数中的4代表4线程, 可自行修改</p></blockquote><h2 id=0x05-准备相关tree>0x05 准备相关tree</h2><p>安卓编译需要三大Tree：Device Tree , Kernel Tree , Vendor Tree
我们都将通过脚本获取，但其中vendor tree由于上文DMCA原因，已经无法正常获取。我们将手动clone<a href=https://gitlab.com/the-muppets/proprietary_vendor_xiaomi>其他repo</a>。(先暂时不要过多宣传该repo为好)，如果你clone vendor失败请看下一节0x06</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>source build/envsetup.sh
git clone https://gitlab.com/the-muppets/proprietary_vendor_xiaomi vendor/xiaomi --depth<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
breakfast sagit
</code></pre></div><h2 id=0x06-提取专有blobs>0x06 提取专有blobs</h2><blockquote><p>上一节vendor获取成功请跳过本节<br>建议手机已root或者装有magisk，未root用户看相关部分plan B</p></blockquote><h3 id=1-plan-a-若你的手机已经root-recommanded>1. PLAN A 若你的手机已经root (Recommanded)</h3><blockquote><p>Magisk 用户需要额外的设置，请去Magisk Manager设置中关闭Magisk Hide，并在手机开发者选项中开启ADB root的权限，最后重启。</p></blockquote><p>开发者选项中开启ADB后通过有线连接电脑</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash> yay -S patchelf android-tools
 cd device/xiaomi/sagit
 adb root <span style=color:#75715e>#非常重要</span>
 ./extract-files.sh
</code></pre></div><h3 id=2-plan-b-若你的手机没有root>2. PLAN B 若你的手机没有root</h3><p>请阅读这篇官方教程了解如何从OTA zip包中提取文件<br><a href=https://wiki.lineageos.org/extracting_blobs_from_zips.html>https://wiki.lineageos.org/extracting_blobs_from_zips.html</a></p><h2 id=0x07-开启cache加速可选>0x07 开启cache加速（可选）</h2><p><strong>需要对剩余空间足够自信，我觉得至少200G吧，所谓牺牲空间换时间</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash> export USE_CCACHE<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
 ccache -M 50G <span style=color:#75715e>#参数为最大cache大小，可调</span>
 export CCACHE_COMPRESS<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> <span style=color:#75715e>#可选命令 压缩cache，节约空间，牺牲性能</span>
</code></pre></div><h2 id=0x08-开始编译>0x08 开始编译</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash> croot
 brunch sagit
</code></pre></div><blockquote><p>进行到99%开始打包有可能会失败，提示“zip I/O error: No space left on device”。这里并不是指硬盘空间不足，而是/tmp 占满了，重新挂载后继续编译就好。</p></blockquote><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash> sudo mount -o remount,size<span style=color:#f92672>=</span>15G,noatime /tmp
 brunch sagit
</code></pre></div><h2 id=0x09-漫长的等待>0x09 漫长的等待</h2><p>打开SWICH，异度之刃2启动！！！</p><h2 id=0x10-获取输出结果>0x10 获取输出结果</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash> cd $OUT
</code></pre></div><p>目录下应该有两个文件，一个是我们需要的zip，另一个是recovery image。</p></div><div class=post-footer><div class=info><span class=separator><a class=tag href=/tags/android/>Android</a><a class=tag href=/tags/lineageos/>LineageOS</a><a class=tag href=/tags/geek/>Geek</a></span></div></div></div></div></div></div><script type=text/javascript src=https://amaothree.github.io/js/jquery.min.64d0083866906099f942140bc1c5cba4b1bf65783c52e4a63c5c46bf9dbc41f4.js integrity="sha256-ZNAIOGaQYJn5QhQLwcXLpLG/ZXg8UuSmPFxGv528QfQ=" crossorigin=anonymous></script><script type=text/javascript src=https://amaothree.github.io/js/bundle.min.45159b0e20ba3878972e064b7edc464c31a9e35a0d0a6a71e3fec84efdbe2ea5.js integrity="sha256-RRWbDiC6OHiXLgZLftxGTDGp41oNCmpx4/7ITv2+LqU=" crossorigin=anonymous></script><script type=text/javascript src=https://amaothree.github.io/js/medium-zoom.min.2d6fd0be87fa98f0c9b4dc2536b312bbca48757f584f6ea1f394abc9bcc38fbc.js integrity="sha256-LW/Qvof6mPDJtNwlNrMSu8pIdX9YT26h85SrybzDj7w=" crossorigin=anonymous></script></body></html>