<!doctype html><html dir=ltr lang=en data-theme><head><title>Amao Three | Creat multi Jenkins containers in Linux based on systemd-nspawn</title><meta charset=utf-8><meta name=generator content="Hugo 0.82.1"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=description content="There are great brave people in the world, and they are not frightened when they are faced with a sudden attack, and they are not angry when they are added for no reason; the person who holds this is very powerful, and his ambition is very distant. --Su Shi"><link rel=stylesheet href=/css/style.min.7ec96a07e10b60a6997be730fc5d4d3467a225c68515a7df6ae17ac2500f828c.css integrity="sha256-fslqB+ELYKaZe+cw/F1NNGeiJcaFFaffauF6wlAPgow=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/markupHighlight.min.f798cbda9aaa38f89eb38be6414bd082cfd71a6780375cbf67b6d2fb2b96491e.css integrity="sha256-95jL2pqqOPies4vmQUvQgs/XGmeAN1y/Z7bS+yuWSR4=" crossorigin=anonymous type=text/css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin=anonymous><link rel="shortcut icon" href=/favicons/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png><link rel=canonical href=/en/posts/systemd-nspwan/><script type=text/javascript src=/js/anatole-header.min.0c05c0a90d28c968a1cad4fb31abd0b8e1264e788ccefed022ae1d3b6f627514.js integrity="sha256-DAXAqQ0oyWihytT7MavQuOEmTniMzv7QIq4dO29idRQ=" crossorigin=anonymous></script><script type=text/javascript src=/js/anatole-theme-switcher.min.7fd87181cdd7e8413aa64b6867bb32f3a8dc242e684fc7d5bbb9f600dbc2b6eb.js integrity="sha256-f9hxgc3X6EE6pktoZ7sy86jcJC5oT8fVu7n2ANvCtus=" crossorigin=anonymous></script><meta name=twitter:card content="summary"><meta name=twitter:title content="Creat multi Jenkins containers in Linux based on systemd-nspawn"><meta name=twitter:description content="0x00 Introduction
This tutorial will describe how to create multiple isolated containers in Linux and run multiple Jenkins in them using Systemd-nspwan container technology."></head><body><div class="sidebar animated fadeInDown"><div class=logo-title><div class=title><img src=/images/profile.jpg alt="profile picture"><h3 title><a href=/>Amao's Casual Writing</a></h3><div class=description><p>There are great brave people in the world, and they are not frightened when they are faced with a sudden attack, and they are not angry when they are added for no reason; the person who holds this is very powerful, and his ambition is very distant. --Su Shi</p></div></div></div><ul class=social-links><li><a href=https://www.linkedin.com/in/yuehao-sui/ rel=me aria-label=Linkedin><i class="fab fa-linkedin fa-2x" aria-hidden=true></i></a></li><li><a href=https://github.com/amaothree rel=me aria-label=GitHub><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li><li><a href=https://www.instagram.com/yoohoo.samuel/ rel=me aria-label=instagram><i class="fab fa-instagram fa-2x" aria-hidden=true></i></a></li><li><a href=mailto:ihidemyname@outlook.com rel=me aria-label=e-mail><i class="fas fa-envelope fa-2x" aria-hidden=true></i></a></li></ul><div class=footer><div class=by_farbox>&copy; Amao Three 2019-2021</div></div></div><div class=main><div class="page-top animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a><ul class=nav id=navMenu><li><a href=/en/ title>Home</a></li><li><a href=/en/posts/ title>posts</a></li><li><a href=/en/about/ title>About</a></li><li><a href=/zh/ title=中文>中文</a></li><li><a href=/en/ title=EN>EN</a></li><li class=theme-switch-item><a class=theme-switch title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></li></ul></div><div class=autopagerize_page_element><div class=content><div class="post animated fadeInDown"><div class=post-content><div class=post-title><h3>Creat multi Jenkins containers in Linux based on systemd-nspawn</h3><div class=info><em class="fas fa-calendar-day"></em><span class=date>Fri, Apr 16, 2021</span>
<em class="fas fa-stopwatch"></em><span class=reading-time>9-minute read</span></div></div><h2 id=0x00-introduction>0x00 Introduction</h2><p>This tutorial will describe how to create multiple isolated containers in Linux and run multiple Jenkins in them using Systemd-nspwan container technology.</p><p>I also write an executable script to help you learning the totural.
You can download and run it:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -o totural.sh https://gist.githubusercontent.com/amaothree/d8bac64e5225b15db84aaf8e3aa6e08d/raw/fdff92ffddac8626584ad823a3b01ce0795c9f4a/totural.
chmod +x ./totural.sh
./totural.sh
</code></pre></div><h2 id=0x01-background>0x01 Background</h2><p>This section will explain the terms that appear in this tutorial. This will help you to have a better understanding of this tutorial.</p><h3 id=linux>Linux</h3><p>Broadly refers to a free and open source operating system. In a narrow sense, it refers to the kernel of the Linux operating system. It is popular in computer science and other data processing fields because it can be freely used and modified and is supported by a complete set of runtime libraries.</p><p>Different communities distribute versions of the Linux operating system based on the Linux kernel and self-selected software libraries. We call them Linux distributions. Famous distributions include Ubuntu, Debian, CentOS (discontinued), Arch Linux, etc.</p><h3 id=wsl>WSL</h3><p>Windows Subsystem for Linux (WSL) is a compatibility layer for running Linux binary executables natively on Windows 10. And in 2019, WSL 2 was announced, it is based on a a highly optimized subset of Hyper-V features. WSL2 introducing important changes such as a real Linux kernel.</p><blockquote><p>If you&rsquo;re still confused, think of WSL2 as a small Linux virtual machine developed by Microsoft that is highly optimised for Windows 10 systems.</p></blockquote><h3 id=systemd>Systemd</h3><p>Systemd is the name of a set of system components under the Linux operating system, and it provides the functionality to manage systems and services.</p><h3 id=systemd-nspwan>Systemd-nspwan</h3><p>Systemd-nspawn is a container tool in systemd. It can be used to run commands or operating systems in a lightweight namespace container.</p><p>Compared to Docker, Systemd-nspawn can only do process isolation (the feature of the namespace) but not resource isolation. Host-to-container or container-to-container processes do not affect each other. But without restrictions, containers and hosts are sharing the same resources (e.g. CPU processing power). Docker uses cgroups to enforce resource isolation (like namespace, cgroups are a part of the linux kernel).</p><h3 id=jenkins>Jenkins</h3><p>An famours open source automation server. With the help of many plugins, Jenkins can help developers automate the building and deploying of software projects.</p><h2 id=0x02-preparation>0x02 Preparation</h2><p>Systemd is a toolset unique to linux systems. You must use the linux operating system to complete this operation.</p><h3 id=if-you-are-a-linux-user>If you are a Linux user</h3><p>Please check that the distribution you are using uses systemd to manage your system by default and that the PID of systemd is 1.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># Run this command to check.</span>
$ ps -A | grep systemd
<span style=color:#75715e># The output should include this line.</span>
<span style=color:#ae81ff>1</span> ?        00:00:00 systemd
</code></pre></div><h3 id=if-you-are-a-macos-user>If you are a macOS user</h3><p>You can run a modern linux distribution such as Ubuntu, Fedora or Arch Linux in a virtual machine.</p><h3 id=if-you-are-a-windows-user>If you are a Windows user</h3><p>You can run a modern linux distribution such as Ubuntu, Fedora or Arch Linux in a virtual machine.</p><h4 id=or-if-you-using-windows-10-version-1903-or-higher>Or If you using Windows 10 Version 1903 or higher</h4><p>You can install <strong>WSL2</strong> (WSL 1 is not work in this totural).</p><p>And for details on how to install WSL2, please read <a href=https://docs.microsoft.com/en-us/windows/wsl/install-win10>Microsoft&rsquo;s official documentation</a>.</p><p>Due to the design of WSL2, Systemd is not started with PID 1 by default in WSL2. This will cause that we basically can&rsquo;t use Systemd&rsquo;s functions properly. However, there is a small tool that can help us fix it very easily.</p><p>This is Genie, to install it please follow this guide. <a href=https://github.com/arkane-systems/genie#installation>Genie&rsquo;s project repository</a>.</p><p>Once installed in WSL2 you can start a &ldquo;Genie mode&rdquo; WSL shell directly in Powershell. <strong>Please note that all the commands that follow you should be executed within Genie mode shell.</strong></p><ul><li>In Powershell</li></ul><blockquote><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Powershell data-lang=Powershell>wsl genie -c bash
</code></pre></div></blockquote><ul><li>Or，In WSL bash</li></ul><blockquote><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Bash data-lang=Bash>genie -c bash
</code></pre></div></blockquote><h2 id=0x03-create-our-first-systemd-nspwan-container>0x03 Create our first Systemd-nspwan container</h2><h3 id=1-create-a-folder-for-the-container>1. Create a folder for the container</h3><p>From the host&rsquo;s view, Systemd-nspwan&rsquo;s containers are just folders by folders. This is because Systemd-nspwan is a lightweight namespace virtualization technology. Similar to the chroot command, but more powerful, it completely virtualizes the file system hierarchy, process tree, various IPC subsystems, and hosts and domains.</p><p>Next we create a folder in our home directory to hold the containers we will create later and a folder for the first container.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Bash data-lang=Bash>mkdir -p ~/MyContainers/Container1
</code></pre></div><p>Then change into the <em>MyContainers</em> folder</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Bash data-lang=Bash>cd ~/MyContainers/
</code></pre></div><h3 id=2-assembling-container>2. Assembling container</h3><p>In this step we have to install the base linux filesystem in the container. Here I recommend and will demonstrate the installation of Arch Linux into a container, because it is very simple and clean without including any extra software. It can greatly reduce the size of a container. Of course you can also choose to install Debian or Ubuntu, but the method is different, please find the installation tutorial by yourself.</p><h4 id=21-get-the-installation-script>2.1 Get the installation script</h4><p>First install the Arch Linux community maintained installation script in WSL. Different package managers use different installation commands.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Bash data-lang=Bash><span style=color:#75715e># Arch Linux</span>
sudo pacman -Syyu arch-install-scripts
<span style=color:#75715e># Debian buster or higher/Ubuntu 18.04LTS or higher</span>
sudo apt update
sudo apt install arch-install-scripts
<span style=color:#75715e># Fedora</span>
sudo dnf install arch-install-scripts
sudo pacman-key --init
sudo pacman-key --populate archlinux
<span style=color:#75715e># </span>
</code></pre></div><h4 id=22-installing-arch-linux-to-container>2.2 Installing Arch Linux to container</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Bash data-lang=Bash>sudo pacstrap -i -c ./Container1/ base
</code></pre></div><blockquote><p>If you get the error &ldquo;Detected unsafe path transition / → &mldr;&rdquo; during the installation, you can ignore it. It will not affect the next operations. This is due to the fact that the root directory ownership in WSL is different from the normal Linux environment.</p></blockquote><h4 id=23-creating-symbolic-links-for-container>2.3 Creating symbolic links for container</h4><p>For different use cases, Systemd has designed several different management tools for nspwan containers. We will use the <em>machinectl</em> tool, which requires us to create containers in /var/lib/machines/, but a better solution is to use symbolic links.</p><blockquote><p>Note: Do not use relative paths to create symbolic links, use absolute paths instead.</p></blockquote><p><code>sudo ln -s /home/usename/MyContainers/Container1/ /var/lib/machines/</code></p><blockquote><p>Here <em>usename</em> should be replaced with your linux username.<br>If you are using the root login, then the path to the home directory is /root.</p></blockquote><p>Check if linked successfully</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>machinectl list-images
</code></pre></div><p>The output should be similar to</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>NAME       TYPE      RO USAGE CREATED                      MODIFIED
Container1 directory no   n/a Fri 2021-04-09 18:18:39 CEST n/a
</code></pre></div><h4 id=24-setting-up-the-container-network>2.4 Setting up the container network</h4><p>Containers managed by <em>machinectl</em> use a private network by default, and the container&rsquo;s network is completely isolated (from the external network as well as from other containers). This would not be suitable for us to manage multiple Jenkins, so we change it to a host networking that allows the host to access the services within the container.</p><p>The path to the container configuration file is <code>/etc/systemd/nspawn/container-name.nspawn</code>. The name of the configuration file corresponds to the container name.</p><p>We edit the configuration file (using nano or vim).</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># If you have not intalled nano</span>
sudo pacman -Syu
sudo pacman -S nano

sudo nano /etc/systemd/nspawn/Container1.nspawn
</code></pre></div><p>Add the following two lines to the file.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cfg data-lang=cfg><span style=color:#66d9ef>[Network]</span>
<span style=color:#a6e22e>VirtualEthernet</span><span style=color:#f92672>=</span><span style=color:#e6db74>no</span>
</code></pre></div><h4 id=25-boot-container-change-root-password>2.5 Boot container, change root password</h4><p>Start the container via <code>machinectl</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo machinectl start Container1
</code></pre></div><p>Checking container status</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>machinectl list
</code></pre></div><p>Through the container&rsquo;s interactive shell session, this step does not invoke the login process.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo machinectl shell Container1
<span style=color:#75715e># When you in the shell</span>
passwd
</code></pre></div><p>Delete the two files immediately after, otherwise you will not be able to log into the container properly next</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>rm /etc/securetty
rm /usr/share/factory/etc/securetty
exit
</code></pre></div><p>After exiting the container&rsquo;s shell, you can log in to the container with the password</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo machinectl login Container1
</code></pre></div><blockquote><ol><li>If you forget your password, to terminate the session from inside the container, hold Ctrl and quickly press ] three times. Non-US keyboard users should use % instead of ].</li><li>When you terminate the session in this way, don&rsquo;t forget to re-enter the geine.</li></ol></blockquote><h3 id=3-installing-jenkins>3. Installing Jenkins</h3><p>Once you are logged into the container, you can use the package manager to install Jenkins and some necessary programs, such as</p><ul><li>Jenkins</li><li>OpenJDK</li><li>Nano or Vim</li><li>Xorg (This is necessary, if xorg is not installed, jenkins will report errors about the GUI, although in fact we don&rsquo;t have any GUI programs installed at all.)</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># Update all packages</span>
pacman -Syu
<span style=color:#75715e># Install packages</span>
pacman -S nano bash-completion jdk-openjdk jenkins xorg sl
</code></pre></div><p>Before starting jenkins, give enough permissions on /var/cache/jenkins in the container</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir /var/cache/jenkins
chmod <span style=color:#ae81ff>777</span> /var/cache/jenkins
</code></pre></div><h3 id=4-start-and-configure-jenkins>4. Start and configure Jenkins</h3><p>Since we&rsquo;ll create the second Jenkins container next, we&rsquo;d better modify the first Jenkins port.</p><p>The configuration file for Jenkins is in <code>/etc/conf.d/jenkins</code></p><p>Change the port number in the line <code>JENKINS_PORT=--httpPort=8090</code> to <code>8091</code></p><p>Now just launch Jenkins inside the container</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Bash data-lang=Bash>systemctl start jenkins
</code></pre></div><p>Then just open <code>http://localhost:8091</code> through your browser on Windows (such as Microsoft Edge) to configure your first Jenkins.</p><p>You can safely <code>logout</code> and your container will keep running, you can check the status of the container and shut it down at any time with the following command:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>machinectl list
machinectl poweroff
</code></pre></div><h2 id=0x04-second-container>0x04 Second container</h2><p>Do you remember what I said before that a container is a folder? If we want to create similar containers, then we just need to copy the folder and generate a new symbolic link to <code>/var/lib/machine</code>. Oh yeah, and don&rsquo;t forget that the new container needs a new configuration file.</p><p>Don&rsquo;t forget to close the container before copying it.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># Turn off container</span>
sudo machinectl poweroff Container1
<span style=color:#75715e># Copy container</span>
sudo cp -r ~/MyContainers/Container1/ ~/MyContainers/Container2/
sudo ln -s /home/amao/MyContainers/Container2/ /var/lib/machines/
sudo cp /etc/systemd/nspawn/Container1.nspawn /etc/systemd/nspawn/Container2.nspawn
</code></pre></div><p>Then check it out</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ machinectl list-images
NAME       TYPE      RO USAGE CREATED                      MODIFIED
Container1 directory no   n/a Fri 2021-04-09 18:18:39 CEST n/a
Container2 directory no   n/a Fri 2021-04-09 18:18:39 CEST n/a

<span style=color:#ae81ff>2</span> images listed.
</code></pre></div><p>Start two containers at the same time</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo machinectl start Container1
sudo machinectl start Container2
sudo machinectl list
MACHINE    CLASS     SERVICE        OS   VERSION ADDRESSES
Container1 container systemd-nspawn arch -       -
Container2 container systemd-nspawn arch -       -

<span style=color:#ae81ff>2</span> machines listed.
</code></pre></div><p>Then just go into different containers for different configurations according to different needs. For example, change the port number of Jenkins in Container2. After that you can access different ports to control different Jenkins through your browser on Windows.</p><h2 id=0x05-packing-containers>0x05 Packing containers</h2><p>If you want to move the container to your other host, you can of course always package and export the container with the <code>machinectl</code> command.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># Export</span>
sudo machinectl export-tar Container1 /home/username/Container1.gz
<span style=color:#75715e># Import</span>
sudo machinectl import-tar /home/username/Container1.gz ContainerX
</code></pre></div><p>You can check the progress with <code>machinectl list-transfers</code> and cancel with <code>machinectl cancel-transfer</code> at any time during the import and export process.</p><p>Thanks for your reading.</p><blockquote><p>Easter egg for you. If you really follow the commands. Try to run <code>sl</code> in Container1.</p></blockquote></div><div class=post-footer><div class=info><span class=separator><a class=tag href=/en/tags/linux/>Linux</a><a class=tag href=/en/tags/devops/>DevOps</a><a class=tag href=/en/tags/wsl/>WSL</a></span></div></div><div id=fb_comments_container><h2>comments</h2><script src=https://utteranc.es/client.js repo=amaothree/gitalk-repo issue-term=title theme=github-dark-orange crossorigin=anonymous async></script></div></div></div></div></div><script type=text/javascript src=/js/medium-zoom.min.2d6fd0be87fa98f0c9b4dc2536b312bbca48757f584f6ea1f394abc9bcc38fbc.js integrity="sha256-LW/Qvof6mPDJtNwlNrMSu8pIdX9YT26h85SrybzDj7w=" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-4GTD2DHRN1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-4GTD2DHRN1')</script></body></html>